<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choose Courier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .courier-cards .card {
      transition: transform 0.2s ease;
    }
    .courier-cards .card:hover {
      transform: scale(1.01);
    }
  </style>
</head>

<body class="bg-light">

<%
  // -----------------------------
  // Helpers
  // -----------------------------

  function getDeliveryDays(courier) {
    if (courier.min_estimated_delivery_time) return Number(courier.min_estimated_delivery_time);
    if (courier.estimated_delivery_days) return Number(courier.estimated_delivery_days);
    return 3; // safe default
  }

  function getDeliveryText(courier) {
    if (courier.min_estimated_delivery_time && courier.max_estimated_delivery_time) {
      if (courier.min_estimated_delivery_time === courier.max_estimated_delivery_time) {
        return courier.min_estimated_delivery_time + " days";
      }
      return courier.min_estimated_delivery_time + " - " + courier.max_estimated_delivery_time + " days";
    }
    if (courier.estimated_delivery_days) {
      return courier.estimated_delivery_days + " days";
    }
    return "N/A";
  }

  // ğŸ”¥ YOUR LOCKER PRICING LOGIC (PER COURIER)
  function getLockerCostForCourier(courier) {
    const days = getDeliveryDays(courier);

    // Pricing rule:
    //  â‚¹10 per  day
    const freeDays = 0; // we cant free days if we want to like first day free etc
    const perDay = 10;

    if (days <= freeDays) return 0;
    return (days - freeDays) * perDay;
  }

  // -----------------------------
  // Sorting
  // -----------------------------

  let sortedCouriers = [...courierOptions];

  const sortType = (typeof query !== "undefined" && query.sort) ? query.sort : "cheapest";

  if (sortType === "fastest") {
    sortedCouriers.sort((a, b) => {
      return getDeliveryDays(a) - getDeliveryDays(b);
    });
  } else {
    // cheapest
    sortedCouriers.sort((a, b) => a.rate - b.rate);
  }
%>

  <!-- Navbar -->
  <%- include('../../partials/navbar') %>

  <div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-semibold">ğŸšš Choose a Courier</h3>

      <div class="btn-group">
        <a href="?sort=cheapest" class="btn btn-outline-primary btn-sm <%= sortType === 'cheapest' ? 'active' : '' %>">
          ğŸ’° Cheapest
        </a>
        <a href="?sort=fastest" class="btn btn-outline-success btn-sm <%= sortType === 'fastest' ? 'active' : '' %>">
          âš¡ Fastest
        </a>
      </div>
    </div>

    <div class="courier-cards">

      <% if (sortedCouriers.length === 0) { %>
        <div class="alert alert-warning">No courier services available for this route.</div>
      <% } %>

      <% sortedCouriers.forEach(courier => { 
        const lockerCost = getLockerCostForCourier(courier);
        const total = Number(courier.rate) + lockerCost;
      %>

        <div class="card shadow-sm mb-4 border-0">
          <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start">

            <div>
              <h5 class="card-title mb-2">
                ğŸšš <span class="text-primary fw-bold"><%= courier.courier_name %></span>
              </h5>

              <ul class="list-unstyled text-secondary small mb-0">
                <li>ğŸ“¦ Courier Cost: â‚¹<%= courier.rate %></li>
                <li>â± Delivery Time: <%= getDeliveryText(courier) %></li>
                <li>ğŸ’¼ Locker Fee: â‚¹<%= lockerCost %></li>
                <li class="fw-bold text-dark mt-1">ğŸ’° Total: â‚¹<%= total %></li>
              </ul>
            </div>

            <form action="/mobile/send/step3" method="get">
              <input type="hidden" name="selectedCourierId" value="<%= courier.courier_company_id %>">
              <input type="hidden" name="rate" value="<%= courier.rate %>">
              <input type="hidden" name="lockerCost" value="<%= lockerCost %>">
              <input type="hidden" name="totalCost" value="<%= total %>">

              <button type="submit" class="btn btn-outline-primary px-4 py-2 mt-3 mt-md-0">
                Select
              </button>
            </form>

          </div>
        </div>

      <% }); %>

    </div>

  </div>

</body>
</html>
